generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  firstName String
  lastName  String
  role      Role      @default(EMPLOYEE)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  employee  Employee?
}

model Department {
  id        String       @id @default(cuid())
  name      String       @unique
  parentId  String?
  parent    Department?  @relation("DepartmentToDepartment", fields: [parentId], references: [id])
  children  Department[] @relation("DepartmentToDepartment")
  employees Employee[]
  vacancies Vacancy[]
}

model Position {
  id           String     @id @default(cuid())
  title        String     @unique
  description  String?
  competencies String[]   @db.Text
  grade        String?
  salaryMin    Int?
  salaryMax    Int?
  employees    Employee[]
  vacancies    Vacancy[]
}

model Employee {
  id             String            @id @default(cuid())
  userId         String            @unique
  departmentId   String?
  positionId     String?
  managerId      String?
  archived       Boolean           @default(false)
  user           User              @relation(fields: [userId], references: [id])
  department     Department?       @relation(fields: [departmentId], references: [id])
  position       Position?         @relation(fields: [positionId], references: [id])
  manager        Employee?         @relation("EmployeeToEmployee", fields: [managerId], references: [id])
  reports        Employee[]        @relation("EmployeeToEmployee")
  attendances    Attendance[]
  leaveRequests  LeaveRequest[]    @relation("LeaveEmployee")
  approvals      LeaveRequest[]    @relation("LeaveApprover")
  documents      Document[]
  enrollments    Enrollment[]
  certifications Certification[]
  goals          Goal[]
  reviewsGiven   Review[]          @relation("ReviewReviewer")
  events         EmploymentEvent[]
  timeEntries    TimeEntry[]
}

model Attendance {
  id         String           @id @default(cuid())
  employeeId String
  date       DateTime
  status     AttendanceStatus
  employee   Employee         @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
}

model LeaveRequest {
  id         String      @id @default(cuid())
  employeeId String
  startDate  DateTime
  endDate    DateTime
  reason     String?
  status     LeaveStatus @default(PENDING)
  approverId String?
  employee   Employee    @relation("LeaveEmployee", fields: [employeeId], references: [id])
  approver   Employee?   @relation("LeaveApprover", fields: [approverId], references: [id])
}

model Document {
  id         String    @id @default(cuid())
  employeeId String?
  filename   String
  path       String
  uploadedAt DateTime  @default(now())
  category   String?
  tags       String[]  @db.Text
  version    Int       @default(1)
  employee   Employee? @relation(fields: [employeeId], references: [id])
}

// Time tracking entries (check-in/out per day)
model TimeEntry {
  id         String   @id @default(cuid())
  employeeId String
  date       DateTime
  startTime  DateTime
  endTime    DateTime
  employee   Employee @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
}

enum Role {
  ADMIN
  HR
  EMPLOYEE
  CANDIDATE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  SICK
  VACATION
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

// Recruitment
model Vacancy {
  id           String        @id @default(cuid())
  title        String
  description  String?
  departmentId String?
  positionId   String?
  status       VacancyStatus @default(OPEN)
  createdAt    DateTime      @default(now())
  skills       String[]      @db.Text
  candidates   Candidate[]
  department   Department?   @relation(fields: [departmentId], references: [id])
  position     Position?     @relation(fields: [positionId], references: [id])
}

model Candidate {
  id          String          @id @default(cuid())
  vacancyId   String
  firstName   String
  lastName    String
  email       String
  resumePath  String?
  tags        String[]        @db.Text
  skills      String[]        @db.Text
  coverLetter String?
  parsedWords String[]        @db.Text
  duplicate   Boolean         @default(false)
  status      CandidateStatus @default(APPLIED)
  createdAt   DateTime        @default(now())
  vacancy     Vacancy         @relation(fields: [vacancyId], references: [id])
  interviews  Interview[]
}

model Interview {
  id          String           @id @default(cuid())
  candidateId String
  scheduledAt DateTime
  result      InterviewResult?
  notes       String?
  feedback    String?
  candidate   Candidate        @relation(fields: [candidateId], references: [id])
}

enum VacancyStatus {
  OPEN
  ON_HOLD
  CLOSED
}

enum CandidateStatus {
  APPLIED
  SCREENING
  INTERVIEW
  OFFER
  HIRED
  REJECTED
}

enum InterviewResult {
  PASS
  FAIL
  PENDING
}

// Learning & Development
model Course {
  id          String       @id @default(cuid())
  title       String
  description String?
  createdAt   DateTime     @default(now())
  enrollments Enrollment[]
}

model Enrollment {
  id         String   @id @default(cuid())
  courseId   String
  employeeId String
  progress   Int      @default(0) // 0..100
  completed  Boolean  @default(false)
  course     Course   @relation(fields: [courseId], references: [id])
  employee   Employee @relation(fields: [employeeId], references: [id])
}

model Certification {
  id         String   @id @default(cuid())
  employeeId String
  name       String
  issuedAt   DateTime @default(now())
  employee   Employee @relation(fields: [employeeId], references: [id])
}

// Performance Management
model Goal {
  id          String     @id @default(cuid())
  employeeId  String
  title       String
  description String?
  status      GoalStatus @default(ACTIVE)
  startDate   DateTime   @default(now())
  endDate     DateTime?
  employee    Employee   @relation(fields: [employeeId], references: [id])
  reviews     Review[]
}

model Review {
  id         String   @id @default(cuid())
  goalId     String
  reviewerId String
  rating     Int
  feedback   String?
  createdAt  DateTime @default(now())
  goal       Goal     @relation(fields: [goalId], references: [id])
  reviewer   Employee @relation("ReviewReviewer", fields: [reviewerId], references: [id])
}

// 360 Feedback
model FeedbackCycle {
  id        String             @id @default(cuid())
  title     String
  startsAt  DateTime           @default(now())
  endsAt    DateTime?
  questions FeedbackQuestion[]
  responses FeedbackResponse[]
}

model FeedbackQuestion {
  id        String             @id @default(cuid())
  cycleId   String
  text      String
  type      FeedbackType       @default(SCALE) // SCALE or TEXT
  cycle     FeedbackCycle      @relation(fields: [cycleId], references: [id])
  responses FeedbackResponse[]
}

model FeedbackResponse {
  id            String           @id @default(cuid())
  cycleId       String
  questionId    String
  targetEmpId   String // who is being reviewed
  reviewerEmpId String // who reviewed (hidden for non-admin)
  reviewerRole  FeedbackRole
  rating        Int?
  comment       String?
  sentiment     Float? // -1..1 calculated on save
  createdAt     DateTime         @default(now())
  cycle         FeedbackCycle    @relation(fields: [cycleId], references: [id])
  question      FeedbackQuestion @relation(fields: [questionId], references: [id])
}

enum FeedbackType {
  SCALE
  TEXT
}

enum FeedbackRole {
  SELF
  PEER
  MANAGER
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// Workforce Analytics (simple materialized metrics tables)
model MetricSnapshot {
  id            String   @id @default(cuid())
  capturedAt    DateTime @default(now())
  employees     Int
  openVacancies Int
  avgTimeToFill Int?
}

// Employment History
model EmploymentEvent {
  id         String              @id @default(cuid())
  employeeId String
  date       DateTime            @default(now())
  type       EmploymentEventType
  title      String
  details    String?
  employee   Employee            @relation(fields: [employeeId], references: [id])
}

enum EmploymentEventType {
  HIRED
  PROMOTION
  TRANSFER
  TERMINATION
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../erd/ERD.svg"
}